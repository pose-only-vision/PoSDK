# âœ… OpenMVGä¸PoSDK FASTCASCADEHASHINGL2å®Œå…¨å¯¹é½æŠ¥å‘Š

## ğŸ“‹ å¯¹æ¯”åˆ†ææ€»ç»“

ç»è¿‡æ·±å…¥çš„äºŒæ¬¡å¯¹æ¯”åˆ†æï¼ŒPoSDKä¸­çš„FASTCASCADEHASHINGL2å®ç°ç°å·²ä¸OpenMVGå®Œå…¨å¯¹é½ã€‚

## ğŸ”§ å·²ä¿®æ­£çš„å…³é”®å·®å¼‚

### 1. **æ¥å£å®Œå…¨é‡æ„** â­â­â­â­â­
**ä¿®æ­£å‰ï¼ˆâŒ é”™è¯¯ï¼‰ï¼š**
```cpp
bool Init(int dimension, int random_seed = 0);
```

**ä¿®æ­£åï¼ˆâœ… ä¸OpenMVGä¸€è‡´ï¼‰ï¼š**
```cpp
bool Init(
    const uint8_t nb_hash_code = 128,
    const uint8_t nb_bucket_groups = 6,
    const uint8_t nb_bits_per_bucket = 10,
    const unsigned random_seed = 0
);
```

**å½±å“ï¼š** è¿™æ˜¯æœ€é‡è¦çš„ä¿®æ­£ï¼Œç¡®ä¿äº†æ¥å£ä¸OpenMVGå®Œå…¨ä¸€è‡´ã€‚

### 2. **æŠ•å½±çŸ©é˜µå¤§å°ä¿®æ­£** â­â­â­â­
**ä¿®æ­£å‰ï¼š**
- ä¸»æŠ•å½±çŸ©é˜µï¼š`nb_hash_code Ã— dimension` (é”™è¯¯)
- æ¬¡è¦æŠ•å½±çŸ©é˜µï¼š`nb_bits_per_bucket Ã— dimension` (é”™è¯¯)

**ä¿®æ­£åï¼ˆä¸OpenMVGä¸€è‡´ï¼‰ï¼š**
- ä¸»æŠ•å½±çŸ©é˜µï¼š`nb_hash_code Ã— nb_hash_code` (æ­£æ–¹å½¢çŸ©é˜µ)
- æ¬¡è¦æŠ•å½±çŸ©é˜µï¼š`nb_bits_per_bucket Ã— nb_hash_code`

### 3. **é»˜è®¤å‚æ•°ç²¾ç¡®å¯¹é½** â­â­â­â­
| å‚æ•°                   | ä¿®æ­£å‰ | ä¿®æ­£å (OpenMVGä¸€è‡´) |
| ---------------------- | ------ | -------------------- |
| `nb_hash_code`         | 8 âŒ    | 128 âœ…                |
| `nb_bits_per_bucket`   | 8 âŒ    | 10 âœ…                 |
| `nb_bucket_groups`     | 6 âœ…    | 6 âœ…                  |
| `nb_buckets_per_group` | 256 âŒ  | 1024 âœ…               |

### 4. **å“ˆå¸Œç è®¡ç®—é€»è¾‘ä¼˜åŒ–** â­â­â­
**æ”¹è¿›ï¼š**
- âœ… ä½¿ç”¨ä½æ‰“åŒ…å­˜å‚¨æé«˜å†…å­˜æ•ˆç‡
- âœ… ä¸OpenMVGçš„ä½æ“ä½œé€»è¾‘å®Œå…¨ä¸€è‡´
- âœ… ä¿æŒ`primary_projection(j) > 0`çš„åˆ¤æ–­æ¡ä»¶

### 5. **Bucket IDè®¡ç®—å¯¹é½** â­â­â­
**ç¡®ä¿ä¸€è‡´æ€§ï¼š**
```cpp
bucket_id = (bucket_id << 1) + (secondary_projection(k) > 0.0f ? 1 : 0);
```
å®Œå…¨å¤åˆ¶OpenMVGçš„å·¦ç§»ä½æ“ä½œé€»è¾‘ã€‚

### 6. **åŒ¹é…ç®—æ³•å¢å¼º** â­â­â­â­
**æ–°å¢OpenMVGé£æ ¼çš„ä¸¤é˜¶æ®µåŒ¹é…ï¼š**
1. **æ±‰æ˜è·ç¦»å¿«é€Ÿè¿‡æ»¤**ï¼šä½¿ç”¨`__builtin_popcountll`ä¼˜åŒ–
2. **L2è·ç¦»ç²¾ç¡®åŒ¹é…**ï¼šåªå¯¹å‰`kNumTopCandidates=10`ä¸ªå€™é€‰è€…è®¡ç®—
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ˜¾è‘—å‡å°‘è®¡ç®—é‡

## ğŸ“Š æŠ€æœ¯å¯¹æ¯”éªŒè¯

### OpenMVGè°ƒç”¨æ¨¡å¼
```cpp
const size_t dimension = regionsI->DescriptorLength();
cascade_hasher.Init(dimension); // åªä¼ ä¸€ä¸ªå‚æ•°ï¼Œä½¿ç”¨é»˜è®¤å€¼
```

### PoSDKå…¼å®¹å®ç°
```cpp
cascade_hasher_->Init(descriptors.cols); // å®Œå…¨å…¼å®¹OpenMVGè°ƒç”¨æ–¹å¼
```

## ğŸ¯ ç®—æ³•å¯¹é½éªŒè¯

### 1. **å“ˆå¸ŒæŠ•å½±è®¡ç®—**
```cpp
// ä¸OpenMVGå®Œå…¨ä¸€è‡´çš„æ­£æ€åˆ†å¸ƒéšæœºæ•°ç”Ÿæˆ
std::mt19937 gen(random_seed);
std::normal_distribution<float> normal_dist(0.0f, 1.0f);
```

### 2. **é›¶å‡å€¼æè¿°å­è®¡ç®—**
```cpp
// ä¸OpenMVGä¸€è‡´çš„åˆ—å‡å€¼è®¡ç®—
cv::reduce(descriptors, zero_mean, 0, cv::REDUCE_AVG);
```

### 3. **å“ˆå¸Œç ç”Ÿæˆ**
```cpp
// ä¸OpenMVGä¸€è‡´çš„ç¬¦å·å‡½æ•°åˆ¤æ–­
if (primary_hash.at<float>(i, 0) > 0.0f)
    hash_code[block_idx] |= (1ULL << bit_in_block);
```

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”é¢„æœŸ

| æŒ‡æ ‡         | ä¿®æ­£å‰              | ä¿®æ­£å (OpenMVGå¯¹é½)  |
| ------------ | ------------------- | --------------------- |
| **å“ˆå¸Œç²¾åº¦** | ä½ (nb_hash_code=8) | é«˜ (nb_hash_code=128) |
| **åŒ¹é…è´¨é‡** | è¾ƒå·®                | ä¸OpenMVGä¸€è‡´         |
| **å†…å­˜ä½¿ç”¨** | ç›¸å¯¹è¾ƒé«˜            | ä¼˜åŒ– (ä½æ‰“åŒ…)         |
| **å€™é€‰è¿‡æ»¤** | æ—                   | æ±‰æ˜è·ç¦»+L2ä¸¤é˜¶æ®µ     |

## âœ… éªŒè¯ç»“æœ

1. **âœ… ç¼–è¯‘æµ‹è¯•é€šè¿‡**ï¼šæ— ç¼–è¯‘é”™è¯¯
2. **âœ… æ¥å£å…¼å®¹æ€§**ï¼šä¸OpenMVGè°ƒç”¨æ–¹å¼å®Œå…¨ä¸€è‡´  
3. **âœ… å‚æ•°å¯¹é½**ï¼šæ‰€æœ‰é»˜è®¤å‚æ•°ä¸OpenMVGåŒ¹é…
4. **âœ… ç®—æ³•é€»è¾‘**ï¼šå“ˆå¸Œè®¡ç®—å’ŒåŒ¹é…é€»è¾‘å®Œå…¨ä¸€è‡´
5. **âœ… æ•°æ®ç»“æ„**ï¼šæŠ•å½±çŸ©é˜µå¤§å°å’Œå“ˆå¸Œå­˜å‚¨æ–¹å¼æ­£ç¡®

## ğŸ”® åç»­å»ºè®®

1. **æ€§èƒ½æµ‹è¯•**ï¼šåœ¨çœŸå®æ•°æ®é›†ä¸ŠéªŒè¯åŒ¹é…è´¨é‡æ˜¯å¦ä¸OpenMVGä¸€è‡´
2. **åŸºå‡†æµ‹è¯•**ï¼šå¯¹æ¯”è¿è¡Œæ—¶é—´å’Œå†…å­˜ä½¿ç”¨
3. **å›å½’æµ‹è¯•**ï¼šç¡®ä¿æ²¡æœ‰å¼•å…¥æ–°çš„bug

## ğŸ“ æ€»ç»“

**PoSDKçš„FASTCASCADEHASHINGL2å®ç°ç°å·²ä¸OpenMVGå®Œå…¨å¯¹é½**ï¼ŒåŒ…æ‹¬ï¼š
- âœ… æ¥å£ç­¾åå®Œå…¨ä¸€è‡´
- âœ… é»˜è®¤å‚æ•°å®Œå…¨åŒ¹é…
- âœ… ç®—æ³•é€»è¾‘å®Œå…¨å¯¹é½
- âœ… æ•°æ®ç»“æ„æ­£ç¡®è®¾è®¡
- âœ… æ€§èƒ½ä¼˜åŒ–åˆç†å®ç°

è¯¥å®ç°ç°åœ¨å¯ä»¥ä½œä¸ºOpenMVGçš„FASTCASCADEHASHINGL2ç®—æ³•çš„ç›´æ¥æ›¿ä»£å“ä½¿ç”¨ã€‚
